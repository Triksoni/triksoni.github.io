<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        body { background: #36393f; color: #fff; display: flex; height: 100vh; }
        .sidebar { width: 240px; background: #2f3136; padding: 20px; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .header { height: 60px; background: #36393f; border-bottom: 1px solid #40444b; padding: 0 20px; display: flex; align-items: center; }
        .chat { flex: 1; padding: 20px; overflow-y: auto; }
        .input-area { padding: 20px; background: #36393f; }
        input { width: 100%; padding: 12px; background: #40444b; border: none; border-radius: 8px; color: white; }
        button { background: #5865f2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 5px 0; width: 100%; }
        .call { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2f3136; padding: 20px; border-radius: 10px; display: none; }
        .call.active { display: block; }
        .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        video { width: 300px; height: 200px; background: #000; border-radius: 8px; }
        .controls { display: flex; gap: 10px; justify-content: center; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; font-size: 20px; }
        .data { background: #40444b; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 12px; max-height: 80px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</h3>
        <button onclick="createOffer()">üì® –°–æ–∑–¥–∞—Ç—å Offer</button>
        <div class="data" id="offerData">Offer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>
        <button onclick="copyOffer()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Offer</button>
        
        <textarea id="answerInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Answer –æ—Ç –¥—Ä—É–≥–∞..." style="width: 100%; height: 60px; margin: 10px 0; padding: 8px; background: #40444b; border: none; border-radius: 4px; color: white;"></textarea>
        <button onclick="applyAnswer()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å Answer</button>
        
        <div class="data" id="answerData">Answer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>
        <button onclick="copyAnswer()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Answer</button>
        
        <button onclick="joinCall()" style="background: #3ba55c; margin-top: 20px;">üîä –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
    </div>

    <div class="main">
        <div class="header">
            <h3>üí¨ –ß–∞—Ç</h3>
        </div>
        <div class="chat" id="chat"></div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key=='Enter') sendMessage()">
        </div>
    </div>

    <div class="call" id="call">
        <h3>üìû –ó–≤–æ–Ω–æ–∫</h3>
        <div class="videos">
            <video id="localVideo" autoplay muted></video>
            <video id="remoteVideo" autoplay></video>
        </div>
        <div class="controls">
            <button class="control-btn" onclick="toggleMute()" id="muteBtn">üé§</button>
            <button class="control-btn" onclick="toggleVideo()" id="videoBtn">üìπ</button>
            <button class="control-btn" onclick="endCall()" style="background: #ed4245;">üìû</button>
        </div>
    </div>

    <script>
        let localStream, peerConnection, dataChannel;
        let isMuted = false, isVideoOn = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = `User${Math.floor(Math.random() * 1000)}`;
        document.getElementById('chat').innerHTML = `<div style="color: #b9bbbe;">ü§ñ –°–∏—Å—Ç–µ–º–∞: –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user}! –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º —Å–ª–µ–≤–∞.</div>`;

        // –°–æ–∑–¥–∞–Ω–∏–µ Offer
        async function createOffer() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                
                peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
                peerConnection.onicecandidate = e => console.log('ICE candidate:', e.candidate);
                
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                // Data channel –¥–ª—è —á–∞—Ç–∞
                dataChannel = peerConnection.createDataChannel('chat');
                dataChannel.onmessage = e => addMessage(JSON.parse(e.data));
                peerConnection.ondatachannel = e => e.channel.onmessage = msg => addMessage(JSON.parse(msg.data));
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                document.getElementById('offerData').textContent = JSON.stringify(offer);
                addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: '‚úÖ Offer —Å–æ–∑–¥–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É.' });
            } catch (e) {
                addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: '‚ùå –û—à–∏–±–∫–∞: ' + e.message });
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Answer
        async function applyAnswer() {
            const answerText = document.getElementById('answerInput').value;
            if (!answerText) return addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: '‚ùå –í–≤–µ–¥–∏—Ç–µ Answer' });
            
            try {
                const answer = JSON.parse(answerText);
                
                if (!peerConnection) {
                    // –ï—Å–ª–∏ –º—ã –ø–æ–ª—É—á–∞–µ–º Offer
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    document.getElementById('localVideo').srcObject = localStream;
                    
                    peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                    peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
                    peerConnection.onicecandidate = e => console.log('ICE candidate:', e.candidate);
                    
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                    peerConnection.ondatachannel = e => e.channel.onmessage = msg => addMessage(JSON.parse(msg.data));
                    
                    const offer = JSON.parse(document.getElementById('offerData').textContent);
                    await peerConnection.setRemoteDescription(offer);
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    document.getElementById('answerData').textContent = JSON.stringify(answer);
                    addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: '‚úÖ Answer —Å–æ–∑–¥–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ.' });
                } else {
                    // –ï—Å–ª–∏ –º—ã –ø—Ä–∏–º–µ–Ω—è–µ–º Answer –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É Offer
                    await peerConnection.setRemoteDescription(answer);
                    addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: '‚úÖ Answer –ø—Ä–∏–º–µ–Ω–µ–Ω!' });
                }
            } catch (e) {
                addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: '‚ùå –û—à–∏–±–∫–∞: ' + e.message });
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        function copyOffer() { copyText(document.getElementById('offerData').textContent, 'Offer'); }
        function copyAnswer() { copyText(document.getElementById('answerData').textContent, 'Answer'); }
        function copyText(text, type) {
            navigator.clipboard.writeText(text).then(() => 
                addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: `‚úÖ ${type} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!` })
            );
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–º
        function joinCall() {
            if (!peerConnection) return addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: '‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ' });
            document.getElementById('call').classList.add('active');
            addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: 'üîä –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç!' });
        }

        function endCall() {
            document.getElementById('call').classList.remove('active');
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (peerConnection) peerConnection.close();
            addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: 'üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω' });
        }

        function toggleMute() {
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
            document.getElementById('muteBtn').style.background = isMuted ? '#ed4245' : '#5865f2';
            addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: isMuted ? 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω' });
        }

        function toggleVideo() {
            if (!localStream) return;
            isVideoOn = !isVideoOn;
            localStream.getVideoTracks().forEach(track => track.enabled = isVideoOn);
            document.getElementById('videoBtn').style.background = isVideoOn ? '#5865f2' : '#ed4245';
            addMessage({ user: 'ü§ñ –°–∏—Å—Ç–µ–º–∞', text: isVideoOn ? 'üìπ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞' : 'üìπ –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞' });
        }

        // –ß–∞—Ç
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            const message = { user: user, text: text };
            addMessage(message);
            
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(message));
            }
            
            input.value = '';
        }

        function addMessage(message) {
            const chat = document.getElementById('chat');
            const msgDiv = document.createElement('div');
            msgDiv.innerHTML = `<strong>${message.user}:</strong> ${message.text}`;
            msgDiv.style.marginBottom = '10px';
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
